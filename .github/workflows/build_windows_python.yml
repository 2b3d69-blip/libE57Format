name: Build E57 Python (Diagnostic Mode)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Repo (Recursive)
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12' 

    - name: Install Ninja & Dependencies
      run: |
        choco install ninja
        pip install pybind11 numpy

    - name: Install Xerces-C (vcpkg)
      run: |
        vcpkg install xerces-c:x64-windows
        vcpkg integrate install

    - name: Configure CMake (Verbose)
      # We force 'Ninja' for speed and better error reporting
      # We explicitly print debug info
      run: >
        cmake -S . -B build -G "Ninja"
        -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        -DE57_BUILD_PYTHON_BINDING=ON
        -DE57_BUILD_TEST=OFF
        -DE57_BUILD_VALIDATION=OFF
        -DCMAKE_BUILD_TYPE=Release
        -DPython3_EXECUTABLE="${{ env.pythonLocation }}\python.exe"

    - name: CHECK CONFIGURATION LOGS
      shell: cmd
      run: |
        echo "-----------------------------------------------------"
        echo "SEARCHING LOGS FOR PYTHON STATUS:"
        type build\CMakeCache.txt | findstr /i "PYTHON"
        echo "-----------------------------------------------------"

    - name: Build
      run: cmake --build build --config Release

    - name: VERIFY OUTPUT (Fail if Missing)
      shell: cmd
      run: |
        echo "Searching for .pyd file..."
        dir /s /b build\*.pyd
        
        if exist build\src\python\e57.pyd (
            echo "SUCCESS: Found e57.pyd in src/python"
        ) else (
            if exist build\e57.pyd (
                echo "SUCCESS: Found e57.pyd in root"
            ) else (
                echo "ERROR: NO .PYD FILE FOUND. BUILD FAILED SILENTLY."
                exit 1
            )
        )

    - name: Stage and Upload
      if: success()
      shell: cmd
      run: |
        mkdir staging
        for /R build %%f in (*.pyd) do copy "%%f" staging\
        copy C:\vcpkg\installed\x64-windows\bin\xerces-c*.dll staging\
        
    - name: Upload Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: e57_diagnostic_build
        path: staging/*
