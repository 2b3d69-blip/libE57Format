name: Debug Build E57 Python 3.12

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Repo (Recursive)
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12' 

    - name: Install Python Build Tools
      # We install pybind11 via PIP so it lives inside the Python 3.12 folder
      run: |
        pip install pybind11 numpy setuptools wheel

    - name: Install Xerces-C (vcpkg)
      # We ONLY use vcpkg for the C++ library (Xerces)
      run: |
        vcpkg install xerces-c:x64-windows
        vcpkg integrate install

    - name: Locate Python Paths
      id: py_info
      shell: python
      run: |
        import sys
        import os
        import pybind11
        print(f"PYTHON_EXEC={sys.executable}")
        print(f"PYTHON_ROOT={os.path.dirname(sys.executable)}")
        print(f"PYBIND11_PATH={pybind11.get_cmake_dir()}")
        # Save these to GitHub Env Vars so CMake can see them
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            f.write(f"PYTHON3_ROOT_DIR={os.path.dirname(sys.executable)}\n")
            f.write(f"pybind11_DIR={pybind11.get_cmake_dir()}\n")

    - name: Configure CMake (Force Python)
      # We explicitly point to the pip-installed pybind11 and the python root
      run: >
        cmake -S . -B build
        -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        -DE57_BUILD_PYTHON_BINDING=ON
        -DE57_BUILD_TEST=OFF
        -DE57_BUILD_VALIDATION=OFF
        -DCMAKE_BUILD_TYPE=Release
        -DPython3_ROOT_DIR="${{ env.PYTHON3_ROOT_DIR }}"
        -DPython3_EXECUTABLE="${{ env.pythonLocation }}\\python.exe"
        -Dpybind11_DIR="${{ env.pybind11_DIR }}"

    - name: Build
      run: cmake --build build --config Release

    - name: GLOBAL SEARCH for PYD
      shell: cmd
      # This searches the entire D: drive workspace for ANY .pyd file
      run: |
        echo "--- SEARCHING EVERYWHERE ---"
        cd D:\a
        dir /s /b *.pyd
        
        echo "--- GATHERING FILES ---"
        mkdir staging
        
        REM Copy any found .pyd file to staging
        for /R D:\a %%f in (*.pyd) do copy "%%f" staging\
        
        REM Copy the Xerces DLL
        copy C:\vcpkg\installed\x64-windows\bin\xerces-c*.dll staging\
        
        echo "--- STAGING CONTENTS ---"
        dir staging

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: e57_debug_package
        path: D:/a/libE57Format/libE57Format/staging/*
        if-no-files-found: error
