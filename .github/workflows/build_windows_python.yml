name: Build E57 Python 3.12 (Strict Mode)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Repo (Recursive)
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12' 

    - name: Install Dependencies
      # Install Ninja for speed and pybind11 via PIP
      run: |
        choco install ninja
        pip install pybind11 numpy setuptools wheel

    - name: Install Xerces-C (vcpkg)
      # We ONLY install Xerces via vcpkg. We keep pybind11 separate to avoid conflicts.
      run: |
        vcpkg install xerces-c:x64-windows
        vcpkg integrate install

    - name: Locate Paths
      id: info
      shell: python
      run: |
        import pybind11, sys, os
        # Calculate paths with forward slashes
        pb_path = pybind11.get_cmake_dir().replace("\\", "/")
        py_root = os.path.dirname(sys.executable).replace("\\", "/")
        
        print(f"Pybind11: {pb_path}")
        print(f"Python Root: {py_root}")
        
        # Save to Env Vars
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            f.write(f"PYBIND11_DIR={pb_path}\n")
            f.write(f"PYTHON_ROOT={py_root}\n")

    - name: PATCH CMakeLists.txt (Force Required)
      # This step edits the build file to CRASH if it can't find Python.
      shell: powershell
      run: |
        $file = "CMakeLists.txt"
        $content = Get-Content $file
        # Force find_package to be REQUIRED so it can't fail silently
        $content = $content -replace 'find_package\(Python3 COMPONENTS Interpreter Development\)', 'find_package(Python3 COMPONENTS Interpreter Development REQUIRED)'
        $content = $content -replace 'find_package\(pybind11 CONFIG\)', 'find_package(pybind11 CONFIG REQUIRED)'
        Set-Content $file $content
        echo "Patched CMakeLists.txt to force Python detection."

    - name: Configure CMake (Strict)
      # If this step turns RED, read the logs! It will tell us exactly what is missing.
      run: >
        cmake -S . -B build -G "Ninja"
        -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        -DE57_BUILD_PYTHON_BINDING=ON
        -DE57_BUILD_TEST=OFF
        -DCMAKE_BUILD_TYPE=Release
        -Dpybind11_DIR="${{ env.PYBIND11_DIR }}"
        -DPython3_ROOT_DIR="${{ env.PYTHON_ROOT }}"
        -DCMAKE_PREFIX_PATH="${{ env.PYTHON_ROOT }}"

    - name: Build
      run: cmake --build build --config Release

    - name: Verify & Stage
      shell: cmd
      run: |
        echo "Searching for output..."
        dir /s /b build\*.pyd
        
        mkdir staging
        for /R build %%f in (*.pyd) do copy "%%f" staging\
        copy C:\vcpkg\installed\x64-windows\bin\xerces-c*.dll staging\
        
        if not exist staging\e57.pyd (
            echo "CRITICAL FAILURE: Build finished but .pyd is missing."
            exit 1
        )

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: e57_strict_python312
        path: staging/*
