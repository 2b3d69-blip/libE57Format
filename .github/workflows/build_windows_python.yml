name: Build E57 Python 3.12 (Jailbreak)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Repo (Recursive)
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12' 

    - name: Install Build Tools
      run: |
        choco install ninja
        pip install pybind11 numpy setuptools wheel

    - name: Install Xerces-C (vcpkg)
      run: |
        vcpkg install xerces-c:x64-windows
        vcpkg integrate install

    - name: JAILBREAK CMakeLists.txt (Force Python)
      shell: python
      # This script edits the CMake file to REMOVE the logic that skips Python
      run: |
        import os
        
        file_path = "CMakeLists.txt"
        with open(file_path, "r") as f:
            content = f.read()
            
        # We look for the line that says "if (E57_BUILD_PYTHON_BINDING)"
        # We replace it with "if (TRUE)" so it ALWAYS executes.
        new_content = content.replace("if (E57_BUILD_PYTHON_BINDING)", "if (TRUE)")
        
        # We also ensure the options don't default to OFF
        new_content = new_content.replace('option(E57_BUILD_PYTHON_BINDING "Build Python binding" OFF)', 'option(E57_BUILD_PYTHON_BINDING "Build Python binding" ON)')
        
        with open(file_path, "w") as f:
            f.write(new_content)
            
        print("Successfully patched CMakeLists.txt to FORCE Python build.")

    - name: Locate Paths
      id: info
      shell: python
      run: |
        import pybind11, sys, os
        pb_path = pybind11.get_cmake_dir().replace("\\", "/")
        py_root = os.path.dirname(sys.executable).replace("\\", "/")
        
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            f.write(f"PYBIND11_DIR={pb_path}\n")
            f.write(f"PYTHON_ROOT={py_root}\n")

    - name: Configure CMake (Jailbroken)
      run: >
        cmake -S . -B build -G "Ninja"
        -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        -DE57_BUILD_PYTHON_BINDING=ON
        -DE57_BUILD_TEST=OFF
        -DCMAKE_BUILD_TYPE=Release
        -Dpybind11_DIR="${{ env.PYBIND11_DIR }}"
        -DPython3_ROOT_DIR="${{ env.PYTHON_ROOT }}"

    - name: Build
      run: cmake --build build --config Release

    - name: Verify Output (Fail Loudly)
      shell: cmd
      run: |
        echo "Searching for .pyd..."
        dir /s /b build\*.pyd
        
        if exist build\src\python\e57.pyd goto found
        if exist build\e57.pyd goto found
        
        REM If we are here, standard paths failed. Let's do a deep search.
        for /R build %%f in (*.pyd) do goto found_somewhere
        
        echo "CRITICAL ERROR: Even after Jailbreak, no .pyd file found."
        exit 1
        
        :found
        echo "Found in standard location."
        goto stage
        
        :found_somewhere
        echo "Found somewhere in build tree."

        :stage
        mkdir staging
        for /R build %%f in (*.pyd) do copy "%%f" staging\
        copy C:\vcpkg\installed\x64-windows\bin\xerces-c*.dll staging\

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: e57_python312_jailbreak
        path: staging/*
