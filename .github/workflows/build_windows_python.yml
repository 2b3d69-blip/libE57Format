name: Build E57 Python (Bulletproof 3.12)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Repo (Recursive)
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12' 

    - name: Install Build Tools
      run: |
        choco install ninja
        pip install pybind11 numpy setuptools wheel

    - name: Install Xerces-C (vcpkg)
      run: |
        vcpkg install xerces-c:x64-windows
        vcpkg integrate install

    - name: Calculate Exact Paths
      id: paths
      shell: python
      run: |
        import pybind11
        import sys
        import os
        
        # 1. Find Pybind11 CMake folder
        pb_path = pybind11.get_cmake_dir().replace("\\", "/")
        
        # 2. Find Python Executable and Root
        py_exec = sys.executable.replace("\\", "/")
        py_root = os.path.dirname(sys.executable).replace("\\", "/")
        
        print(f"Pybind11 DIR: {pb_path}")
        print(f"Python EXEC:  {py_exec}")
        print(f"Python ROOT:  {py_root}")
        
        # 3. Save to Env Vars for CMake
        with open(os.environ['GITHUB_ENV'], 'a') as f:
            f.write(f"PYBIND11_DIR={pb_path}\n")
            f.write(f"PYTHON_EXEC={py_exec}\n")
            f.write(f"PYTHON_ROOT={py_root}\n")

    - name: Configure CMake (Hard-Coded)
      # We pass ALL 3 paths explicitly to prevent "not found" errors
      run: >
        cmake -S . -B build -G "Ninja"
        -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        -DE57_BUILD_PYTHON_BINDING=ON
        -DE57_BUILD_TEST=OFF
        -DCMAKE_BUILD_TYPE=Release
        -Dpybind11_DIR="${{ env.PYBIND11_DIR }}"
        -DPython3_ROOT_DIR="${{ env.PYTHON_ROOT }}"
        -DPython3_EXECUTABLE="${{ env.PYTHON_EXEC }}"

    - name: Build
      run: cmake --build build --config Release

    - name: Verify Output (Fail Loudly)
      shell: cmd
      run: |
        echo "Searching for .pyd..."
        dir /s /b build\*.pyd
        
        if exist build\src\python\e57.pyd goto found
        if exist build\e57.pyd goto found
        
        echo "ERROR: Still no .pyd file! Check the logs above."
        exit 1
        
        :found
        echo "SUCCESS: File exists!"

    - name: Stage Files
      shell: cmd
      run: |
        mkdir staging
        for /R build %%f in (*.pyd) do copy "%%f" staging\
        copy C:\vcpkg\installed\x64-windows\bin\xerces-c*.dll staging\

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: e57_python312_bulletproof
        path: staging/*
