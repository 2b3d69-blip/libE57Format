name: Build E57 Python 3.12 (Ninja + Hardcoded Paths)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Repo (Recursive)
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12' 

    - name: Install Ninja & Tools
      run: |
        choco install ninja
        pip install pybind11 numpy

    - name: Install Xerces & Pybind11 (vcpkg)
      # We install both here. Ninja needs vcpkg to find them.
      run: |
        vcpkg install xerces-c:x64-windows pybind11:x64-windows
        vcpkg integrate install

    - name: Configure CMake (Hard-Coded Paths)
      # We assume the standard GitHub Actions Python path structure
      # We force -G "Ninja" to avoid Visual Studio confusion
      run: >
        cmake -S . -B build -G "Ninja"
        -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        -DE57_BUILD_PYTHON_BINDING=ON
        -DE57_BUILD_TEST=OFF
        -DCMAKE_BUILD_TYPE=Release
        -DPython3_EXECUTABLE="${{ env.pythonLocation }}\python.exe"
        -DPython3_INCLUDE_DIR="${{ env.pythonLocation }}\include"
        -DPython3_LIBRARY="${{ env.pythonLocation }}\libs\python312.lib"
        -DPython3_NumPy_INCLUDE_DIR="${{ env.pythonLocation }}\Lib\site-packages\numpy\core\include"

    - name: Check Configuration (Debug)
      # This will print the log. IF THIS SAYS "Python bindings disabled", we know why.
      shell: cmd
      run: |
        type build\CMakeCache.txt | findstr "E57_BUILD_PYTHON"
        type build\CMakeCache.txt | findstr "Python3"

    - name: Build
      run: cmake --build build --config Release

    - name: Locate Output
      shell: cmd
      run: |
        echo "--- SEARCHING FOR PYD ---"
        dir /s /b build\*.pyd
        
        mkdir staging
        
        REM Ninja usually puts output directly in 'build', not 'build/Release'
        for /R build %%f in (*.pyd) do copy "%%f" staging\
        
        REM Grab the DLL
        copy C:\vcpkg\installed\x64-windows\bin\xerces-c*.dll staging\
        
        echo "--- STAGING CONTENTS ---"
        dir staging

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: e57_ninja_build
        path: staging/*
        if-no-files-found: error
